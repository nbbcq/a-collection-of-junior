## 从 FS 到 BtrFS：文件系统的过去、现在以及未来

一份简短的类 Unix 文件系统发展历史。

什么是文件系统？简单地说，它是一种存储和组织计算机数据的方法，隐藏了硬件设备的细节，为内核提供统一的 IO 操作接口。

说到操作系统的历史，总少不了类 Unix 系统。文件管理作为操作系统的一项重要功能，必然与其相伴相随。Unix 文件系统的发展历程称得上是整个文件系统发展史上的一个缩影。

文件系统的种类有很多，磁盘文件系统、光盘文件系统、闪存文件系统等等，但这里只谈一谈磁盘文件系统。

## 开始：System V FS（S5FS）（c. 1974）

在 1974 年，第一代文件系统伴随着 System V 出现了，它是第一个 Unix 文件系统。

它创造了 `superblock / inode` 概念，这点被以后的文件系统所继承。

下面的图抽象了它的逻辑结构，如果一个词来形如它：简单，简单得不能再简单，没有任何复杂的原理，结构一目了然。

同时速度也非常非常地慢，带宽利用率只有 2-5%。

慢？为什么慢呢？

有个结论：块越大，速度越快。可是 Unix 系统中包含了太多的小文件，大块必然会带来大量空间的浪费。

在空间与速度的较量中，它选择了空间，block size 很小。

另一方面，磁盘并不是随机存储介质，FS 没有考虑磁盘的寻址时间。实际上，访问一次文件往往需要几十次的磁盘访问，所需要的时间是十分恐怖的。

可以看到，是不合理的块大小以及文件的随机存放导致磁盘读写速度很慢。为了改进文件系统的吞吐量，伯克利设计了下一代 Unix 文件系统。

## Berkeley Fast File Systm（FFS or UFS）(c. 1984)

它利用了计算机的局部性原理，将磁盘划分为多个柱面组，确保数据与 inode 在相同的组中、同一文件夹下的文件及其信息尽可能地放在同一组、大文件的块组织尽可能的连续。

这些措施使它获得了更好的性能：14% - 17% 的带宽利用率。可分片的设计也节省了接近一半的空间。

与先前的文件系统相比，还有一点巨大的不同，它增加了文件一致性检查工具 fsck。在系统掉电或磁盘发生问题后，使文件的恢复更加容易。

此后的若干年间，FFS 不断改进，不久添加了日志功能，九十年代初期改进了块分配与预读取策略。这些，大大提升了它的性能。

这一切看起来很美好...可事情往往不会发展得那么顺利。

## 担心

从这张表中可以看到，过去的十年间， CPU 的性能飞速增长，磁盘吞吐量的增长却十分缓慢，有趋势表明未来程序的瓶颈在磁盘。

部分人还作出了这种假设：主存容量不断增长，文件缓存于主存中会大大加快读取速度，这样的话，瓶颈在于文件的写入。

同时，那时的文件系统存在两个问题：

1. 写入小文件的时候，带宽利用率很低；
2. 同步写入时，会阻塞当前进程。

基于以上三种考虑，一种新的文件系统被设计了出来——

## Log-structured File System（LFS）(c. 1991)

它的特点很明显：使用日志的方式记录数据，日志即数据，数据即日志。LFS 中数据的修改都是追加到日志末尾，将磁盘的随机写转化成顺序写。

带来的好处也很明显：写入时， 70% 的带宽利用率；日志的存在，容易修复损坏的文件。

但致命的是，为了操作更有效率，它需要大量的空闲空间来写入新的数据。

很遗憾，历史证明了一切，这文件系统不怎么好。

## Write Anywhere File Layout(WAFL)(c. 1994)

1994 年，WAFL 发布，它算不上是一个文件系统，是一种文件布局。

不过带来了几项很新颖的设计：

* Copy-on-Write，写时复制。

  简单地说，COW 只复制引用而避免复制数据；当的确需要进行写入操作时，会如图中所描述的那样，首先进行数据的拷贝，再对拷贝后的数据执行写入操作，之后再更新各个父节点的信息。

  这样，便无需担心意外断电等突发情况导致的文件一致性错误。

* 元信息存储在文件中。

  它允许在硬盘上的任何地方写入元数据块，使文件系统的增长变得十分容易。

## SGI's XFS（c. 1996）

1996 年，XFS 发布。在 XFS 文件系统中，引入了逻辑卷管理功能(LVM，Logical Volume Manager)。它的重点在于“可以弹性地调整文件系统的容量”。

什么意思呢？举个现象：使用若干月后，Windows 系统的 C 盘往往不够用，大多数人会选择重新分区、格式化、拷贝原始的数据。这太繁琐了。逻辑卷管理便是用于解决这个问题的。

它还采用了 B+ 树组织文件结构，优化了多线程的读写，采用动态 inode 分配策略，拥有了 90 - 95% 的带宽利用率。

此后的几年间，文件系统不断改进，先后出现了其它几种文件系统，直到 2004 年...

## Zettabyte File System (ZFS) (c. 2004)

 ZFS 为传统的磁盘设计，号称最后一个文件系统。

它除了是第一个128位的文件系统外，还从根本上改变了文件系统的管理方式，所有的存储设备都是通过存储池进行管理，只要把各种存储设备加 入同一个存储池中，就可以轻松地管理配置文件系统。

它继承并改进了 WAFL ，基于事物的操作，完全保证了数据的正确和完整，再也不需要文件一致性检查与修复工具了。

可变大小的数据块、智能预读取等特性保证了速度。

此外，在安全、配额、预留、镜像等方面提供了许多企业级别的超强功能。

## Btrfs （c. 2009）

ZFS 的确带来了很多崭新的观念，对文件系统来讲是一个划时代的作品。因其开源许可证的原因，它并不能被整合到 Linux 内核中。Linux 社区开发了 Btrfs，比较 Btrfs 的特性，会发现 Btrfs 和 ZFS 非常类似。也许可以认为 Btrfs 就是 Linux 社区对 ZFS 所作出的回应。从此往后在 Linux 中也终于有了一个可以和 ZFS 相媲美的文件系统了。

## 总结

回首类 Unix 文件系统的发展史，简单来说，文件系统的设计大多集中于吞吐率、一致性、扩展性三个方面。

在空闲块的分配上，不断优化块分配策略，由块簇到区段再到可变块。

对于索引方式，由链表换成表格，再到 B 树。

也不断改进文件系统的一致性，先后出现了文件系统一致性检查工具、日志、写时更新策略等。

元信息组织的不断改进，以及卷管理、存储池概念的引入大大改善了文件系统的拓展性。

近些年来，固态硬盘发展迅速，传统的磁盘文件系统并不能很好地发挥固态硬盘的特性。2016年的 WWDC 大会上，Apple 公布了一个名为 APFS（Apple File System）的文件系统，专为闪存和固态存储设备优化。可以预见，未来越来越多的文件系统会针对固态硬盘进行优化，亦或专门设计...

总而言之，文件系统已经很成熟了吗？我看未必，新存储方式的流行、旧方式的淘汰，必将催生出一批新的文件系统。